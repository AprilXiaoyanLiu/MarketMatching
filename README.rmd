# Market Matching and Causal Impact Inference
If you ever spent time in the field of marketing analytics, chances are that you have analyzed the causal impact of various events (interventions) using time series techniques. An event in this context could be a new TV or radio campaign, a major PR event, or some external event such as a new local competitor. These are all events where we cannot track the impact at the indidual customer level and hence have to analyze the impact from a bird's eye view – i.e., we have to analyze aggregated time series data, typically at the market level (e.g., DMA state, etc.). Data science may be changing, but this is a use-case that has been around forever and is still very relavant.  

An intervention analysis usually involves two steps:

1. Find plausible *control* markets for the *test* market where the event took place, using time series matching based on data prior to the event (pre period).
2. Analyze the causal impact of the event by comparing the observed data for the test and control markets following the event (post period), factoring in differences prior to the event. 

For step 1, the most straight-forward approach to this would be to use a simple Euclidian distance or correlation coefficient. However, this approach implicitly over-penalizes instances where the markets are shifted. Although it is preferable for test and control markets to be aligned consistently, occassional historical shifts should not eliminate control market candidates. For step 2, the traditional approach is a "diff in diff" model. However, this assumes  are i.i.d. and that the differences between the test and control markets is constant – assumptions that rarely hold true for time series data.

A better approach is to use *dynamic time warping* for the time series matching (step 1) which finds the minimal-path distance between two time series within some user-defined constraint (time window). For the intervention analysis (step 2), the most robust approach seems to be the method implemented in the `CausalImpact` package created by Kay Brodersen at Google. The `CausalImpact` package constructs a synthetic baseline for the post-intervention period based on a state space model with linear regression components based on a set of plausible control markets. 

In theory, we don't really need step 1 to do these type of analyses; the `CausalImpact` package can select the most predictive markets for the state space model using spike-and-slab priors. However, when dealing with a large candidate control markets it is prudent to trim the list before applying variable selection. 

# About MarketMatching Package

The `MarketMatching` package implements the workflow described above by providing a "wrapper" for the two packages above so that minimal input is required from the user and output can easily be extracted for presentations. 


# Simple Example
```{r, echo = TRUE, message=FALSE, eval=FALSE}
library(MarketMatching)
##-----------------------------------------------------------------------
## Find best matches for each airport time series
##-----------------------------------------------------------------------
library(MarketMatching)
data(weather, package="MarketMatching")
mm <- best_matches(data=weather, id_variable="Area", 
                  date_variable="Date", 
                  matching_variable="Mean_TemperatureF", 
                  parallel=FALSE, 
                  start_match_period="2014-01-01",
                  end_match_period="2014-10-01")
head(mm$Distances)
subset(mm$Distances, Area=="CPH")
 
##-----------------------------------------------------------------------
## Analyze causal impact of a made-up weather intervention in Copenhagen
## Since this is weather data this is a meaningless example and we should 
## expect no causal impact. This is just to demo the function.
## We're using a tight prior SD on the local level term.
##-----------------------------------------------------------------------
library(CausalImpact)
results <- MarketMatching::inference(matched_markets = mm, 
                                    test_market = "CPH", 
                                    end_post_period = "2015-10-01",
                                    prior_level_sd = 0.002)
 
## Plot the impact
results$PlotAbsoluteEffect
 
## Plot actual observations for test market (CPH) versus the expectation (based on the control)
results$PlotActualVersusFitted
```

# How to Install
```{r, eval=FALSE}
library(devtools)
install_github("google/CausalImpact")
install_github("klarsen1/MarketMatching", "klarsen1")
```

# References
CausalImpact version 1.0.3, Brodersen et al., Annals of Applied Statistics (2015). http://google.github.io/CausalImpact/

Vignette for the `dtw` package: https://cran.r-project.org/web/packages/dtw/vignettes/dtw.pdf.