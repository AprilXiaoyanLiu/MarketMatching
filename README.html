<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Kim Larsen" />

<meta name="date" content="2015-12-28" />

<title>MarketMatching Package Vignette</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link href="data:text/css,body%20%7B%0A%20%20background%2Dcolor%3A%20%23fff%3B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20max%2Dwidth%3A%20700px%3B%0A%20%20overflow%3A%20visible%3B%0A%20%20padding%2Dleft%3A%202em%3B%0A%20%20padding%2Dright%3A%202em%3B%0A%20%20font%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20font%2Dsize%3A%2014px%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%7D%0A%0A%23header%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0A%23TOC%20%7B%0A%20%20clear%3A%20both%3B%0A%20%20margin%3A%200%200%2010px%2010px%3B%0A%20%20padding%3A%204px%3B%0A%20%20width%3A%20400px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20border%2Dradius%3A%205px%3B%0A%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20font%2Dsize%3A%2013px%3B%0A%20%20line%2Dheight%3A%201%2E3%3B%0A%7D%0A%20%20%23TOC%20%2Etoctitle%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%20%20font%2Dsize%3A%2015px%3B%0A%20%20%20%20margin%2Dleft%3A%205px%3B%0A%20%20%7D%0A%0A%20%20%23TOC%20ul%20%7B%0A%20%20%20%20padding%2Dleft%3A%2040px%3B%0A%20%20%20%20margin%2Dleft%3A%20%2D1%2E5em%3B%0A%20%20%20%20margin%2Dtop%3A%205px%3B%0A%20%20%20%20margin%2Dbottom%3A%205px%3B%0A%20%20%7D%0A%20%20%23TOC%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dleft%3A%20%2D2em%3B%0A%20%20%7D%0A%20%20%23TOC%20li%20%7B%0A%20%20%20%20line%2Dheight%3A%2016px%3B%0A%20%20%7D%0A%0Atable%20%7B%0A%20%20margin%3A%201em%20auto%3B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dcolor%3A%20%23DDDDDD%3B%0A%20%20border%2Dstyle%3A%20outset%3B%0A%20%20border%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0A%20%20border%2Dwidth%3A%202px%3B%0A%20%20padding%3A%205px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0A%20%20border%2Dwidth%3A%201px%3B%0A%20%20border%2Dstyle%3A%20inset%3B%0A%20%20line%2Dheight%3A%2018px%3B%0A%20%20padding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0A%20%20border%2Dleft%2Dstyle%3A%20none%3B%0A%20%20border%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%2E5em%200%3B%0A%7D%0A%0Ablockquote%20%7B%0A%20%20background%2Dcolor%3A%20%23f6f6f6%3B%0A%20%20padding%3A%200%2E25em%200%2E75em%3B%0A%7D%0A%0Ahr%20%7B%0A%20%20border%2Dstyle%3A%20solid%3B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dtop%3A%201px%20solid%20%23777%3B%0A%20%20margin%3A%2028px%200%3B%0A%7D%0A%0Adl%20%7B%0A%20%20margin%2Dleft%3A%200%3B%0A%7D%0A%20%20dl%20dd%20%7B%0A%20%20%20%20margin%2Dbottom%3A%2013px%3B%0A%20%20%20%20margin%2Dleft%3A%2013px%3B%0A%20%20%7D%0A%20%20dl%20dt%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%0A%20%20%7D%0A%0Aul%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%7D%0A%20%20ul%20li%20%7B%0A%20%20%20%20list%2Dstyle%3A%20circle%20outside%3B%0A%20%20%7D%0A%20%20ul%20ul%20%7B%0A%20%20%20%20margin%2Dbottom%3A%200%3B%0A%20%20%7D%0A%0Apre%2C%20code%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20color%3A%20%23333%3B%0A%7D%0Apre%20%7B%0A%20%20white%2Dspace%3A%20pre%2Dwrap%3B%20%20%20%20%2F%2A%20Wrap%20long%20lines%20%2A%2F%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20margin%3A%205px%200px%2010px%200px%3B%0A%20%20padding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0A%20%20background%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0A%20%20font%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0A%20%20padding%3A%202px%200px%3B%0A%7D%0A%0Adiv%2Efigure%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0A%20%20background%2Dcolor%3A%20%23FFFFFF%3B%0A%20%20padding%3A%202px%3B%0A%20%20border%3A%201px%20solid%20%23DDDDDD%3B%0A%20%20border%2Dradius%3A%203px%3B%0A%20%20border%3A%201px%20solid%20%23CCCCCC%3B%0A%20%20margin%3A%200%205px%3B%0A%7D%0A%0Ah1%20%7B%0A%20%20margin%2Dtop%3A%200%3B%0A%20%20font%2Dsize%3A%2035px%3B%0A%20%20line%2Dheight%3A%2040px%3B%0A%7D%0A%0Ah2%20%7B%0A%20%20border%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20padding%2Dbottom%3A%202px%3B%0A%20%20font%2Dsize%3A%20145%25%3B%0A%7D%0A%0Ah3%20%7B%0A%20%20border%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0A%20%20padding%2Dtop%3A%2010px%3B%0A%20%20font%2Dsize%3A%20120%25%3B%0A%7D%0A%0Ah4%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0A%20%20margin%2Dleft%3A%208px%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Ah5%2C%20h6%20%7B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23ccc%3B%0A%20%20font%2Dsize%3A%20105%25%3B%0A%7D%0A%0Aa%20%7B%0A%20%20color%3A%20%230033dd%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%236666ff%3B%20%7D%0A%20%20a%3Avisited%20%7B%0A%20%20%20%20color%3A%20%23800080%3B%20%7D%0A%20%20a%3Avisited%3Ahover%20%7B%0A%20%20%20%20color%3A%20%23BB00BB%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%20%20a%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%20%7D%0A%0A%2F%2A%20Class%20described%20in%20https%3A%2F%2Fbenjeffrey%2Ecom%2Fposts%2Fpandoc%2Dsyntax%2Dhighlighting%2Dcss%0A%20%20%20Colours%20from%20https%3A%2F%2Fgist%2Egithub%2Ecom%2Frobsimmons%2F1172277%20%2A%2F%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Keyword%20%2A%2F%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%2F%2A%20DataType%20%2A%2F%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%2F%2A%20DecVal%20%28decimal%20values%29%20%2A%2F%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20BaseN%20%2A%2F%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Float%20%2A%2F%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20Char%20%2A%2F%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%2F%2A%20String%20%2A%2F%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%2F%2A%20Comment%20%2A%2F%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%2F%2A%20OtherToken%20%2A%2F%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20AlertToken%20%2A%2F%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%2F%2A%20Function%20calls%20%2A%2F%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%2F%2A%20ErrorTok%20%2A%2F%0A%0A" rel="stylesheet" type="text/css" />

</head>

<body>



<div id="header">
<h1 class="title">MarketMatching Package Vignette</h1>
<h4 class="author"><em>Kim Larsen</em></h4>
<h4 class="date"><em>2015-12-28</em></h4>
</div>


<div id="market-matching-and-causal-impact-inference" class="section level1">
<h1>Market Matching and Causal Impact Inference</h1>
<p>If you ever spent time in the field of marketing analytics, chances are that you have analyzed the causal impact of various events (interventions) using time series techniques. An event in this context could be a new TV or radio campaign, a major PR event, or some external event such as a new local competitor. These are all events where we cannot track the impact at the individual customer level and hence have to analyze the impact from a bird’s eye view – i.e., we have to analyze aggregated time series data, typically at the market level (e.g., DMA, state, etc.). Data science may be changing, but this is a use-case that has been around forever and is still very relevant.</p>
<p>An intervention analysis usually involves two steps:</p>
<ol style="list-style-type: decimal">
<li>Find matching <em>control</em> markets for the <em>test</em> market where the event took place, using time series matching based on data prior to the event (pre period).</li>
<li>Analyze the causal impact of the event by comparing the observed data for the test and control markets following the event (post period), factoring in differences prior to the event.</li>
</ol>
<div id="a-traditional-approach" class="section level2">
<h2>A Traditional Approach</h2>
<p>For step 1, the most straight-forward approach to this would be to use the Euclidian distance to find the best matching control market. However, this approach implicitly over-penalizes instances where the markets are shifted. Although it is preferable for test and control markets to be aligned consistently, occasional historical shifts should not eliminate good control market candidates. For step 2, the traditional approach is a “diff in diff” model where the difference between the test market and the best matching control market is modeled. However, this assumes are i.i.d. and that the differences between the test and control markets is constant – assumptions that rarely hold true for time series data.</p>
</div>
<div id="a-more-flexible-approach" class="section level2">
<h2>A More Flexible Approach</h2>
<p>A better approach is to use <em>dynamic time warping</em> for the time series matching step. This technique finds the distance along the <em>warping curve</em> – instead of the raw data – where the warping curve represents the best alignment between two time series within some user-defined constraint (time window). For the intervention analysis, <code>CausalImpact</code> package created by Kay Brodersen at Google provides an approach that is more flexible than “diff in diff” (see [1]). The <code>CausalImpact</code> package constructs a synthetic baseline for the post-intervention period based on a structural time series model with linear regression components based <em>multiple</em> matching control markets.</p>
</div>
<div id="notes-on-the-workflow" class="section level2">
<h2>Notes on the Workflow</h2>
<p>The dynamic time warping step is not a strictly necessary step to execute this workflow; we can select markets directly while building the time series model during step 2. In fact, the <code>CausalImpact</code> package selects the most predictive markets for the structural time series model using spike-and-slab priors. This, we could jump directly to the <code>CausalImpact</code> package without pre-screening the markets.</p>
<p>However, when dealing with a large set of candidate control markets it is often prudent to trim the list before selecting the final markets and we rarely need more than three markets to create robust synthetic control series. Moreover, basing the synthetic control on markets that have small distances to the test market boosts the face-validity of the analysis as these control markets tend to be similar in “size” and hence be recognized as viable controls. Ultimately, this is a matter of preference. The good news is that the <code>MarketMatching</code> package allows users to decide how many control markets should pass the filter in step 1.</p>
<p>Last but not least, one can argue that the initial screening should be correlation-based and that distances are irrelevant – i.e., the “sizes” of the control markets do not matter as long as they are predictive. Again, this is a matter of preferences. The <code>MarketMatching</code> package allows the user to control whether the ranking is correlation-based or dtw-based using the <code>dtw_emphasis</code> parameter.</p>
</div>
</div>
<div id="about-marketmatching-package" class="section level1">
<h1>About MarketMatching Package</h1>
<p>The <code>MarketMatching</code> package implements the workflow described above by providing a “wrapper” for the <code>dtw</code> and <code>CausalImpact</code> packages. R packages are a great way of implementing and documenting workflows.</p>
<p>Hence, the package does not provide any functionality that cannot be found in these packages, but rather simplifies the workflow by setting up the data and providing output that can easily be extracted for presentations. Summary of features:</p>
<ul>
<li>Minimal inputs required. The only strictly necessary inputs are the name of the test market (for inference) and the dates of the pre-period and post-period.</li>
<li>Provides a data.frame with the best <span class="math">\(K\)</span> matches for all markets in the input dataset. <span class="math">\(K\)</span> can be defined by the user.</li>
<li>Outputs all inference results as objects with intuitive names (e.g., “AbsoluteEffect” and “RelativeEffect”).</li>
<li>Calculates MAPE and Durbin-Watson for the pre-period. Shows how these statistics change when you alter the prior standard error of the local level term.</li>
<li>Plots and outputs the actual data for the markets selected during the initial market matching.</li>
<li>Plots and outputs actual versus predicted values.</li>
<li>Plots the final local level term.</li>
<li>Shows the average estimated coefficients for all the markets used in the linear regression component of the structural time series model.</li>
<li>Allows the user to choose how many markets are sent to the slab-and-prior model.</li>
<li>All plots are done in <code>ggplot2</code> and can easily be manipulated.</li>
</ul>
</div>
<div id="how-to-install" class="section level1">
<h1>How to Install</h1>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(devtools)
<span class="kw">install_github</span>(<span class="st">&quot;google/CausalImpact&quot;</span>)
<span class="kw">install_github</span>(<span class="st">&quot;klarsen1/MarketMatching&quot;</span>, <span class="st">&quot;klarsen1&quot;</span>)</code></pre>
</div>
<div id="example" class="section level1">
<h1>Example</h1>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(MarketMatching)
##-----------------------------------------------------------------------
## Find the best matches (default is 5) for each airport time series
##-----------------------------------------------------------------------
<span class="kw">library</span>(MarketMatching)
<span class="kw">data</span>(weather, <span class="dt">package=</span><span class="st">&quot;MarketMatching&quot;</span>)
mm &lt;-<span class="st"> </span><span class="kw">best_matches</span>(<span class="dt">data=</span>weather, 
                   <span class="dt">id_variable=</span><span class="st">&quot;Area&quot;</span>, 
                   <span class="dt">date_variable=</span><span class="st">&quot;Date&quot;</span>, 
                   <span class="dt">matching_variable=</span><span class="st">&quot;Mean_TemperatureF&quot;</span>, 
                   <span class="dt">parallel=</span><span class="ot">TRUE</span>,
                   <span class="dt">start_match_period=</span><span class="st">&quot;2014-01-01&quot;</span>,
                   <span class="dt">end_match_period=</span><span class="st">&quot;2014-10-01&quot;</span>)
##-----------------------------------------------------------------------
## Analyze causal impact of a made-up weather intervention in Copenhagen
## Since this is weather data this is a meaningless example and we should 
## expect no causal impact. This is just to demo the function.
##-----------------------------------------------------------------------
<span class="kw">library</span>(CausalImpact)
results &lt;-<span class="st"> </span>MarketMatching::<span class="kw">inference</span>(<span class="dt">matched_markets =</span> mm, 
                                    <span class="dt">test_market =</span> <span class="st">&quot;CPH&quot;</span>, 
                                    <span class="dt">end_post_period =</span> <span class="st">&quot;2015-10-01&quot;</span>)</code></pre>
<p>A view of the best matches data.frame generated by the best_matches() function:</p>
<pre class="sourceCode r"><code class="sourceCode r">knitr::<span class="kw">kable</span>(<span class="kw">head</span>(mm$BestMatches))</code></pre>
<p>Plotting the absolute impact</p>
<pre class="sourceCode r"><code class="sourceCode r">results$PlotAbsoluteEffect</code></pre>
<p>Plot actual observations for test market (CPH) versus the expectation</p>
<pre class="sourceCode r"><code class="sourceCode r">results$PlotActualVersusExpected</code></pre>
<p>Store actual versus predicted in a data.frame</p>
<pre class="sourceCode r"><code class="sourceCode r">pred &lt;-<span class="st"> </span>results$Predictions
knitr::<span class="kw">kable</span>(<span class="kw">head</span>(pred))</code></pre>
<p>PLot the actual data for the test and control markets</p>
<pre class="sourceCode r"><code class="sourceCode r">results$PlotActuals</code></pre>
<p>Check DW, MAPE and largest market coefficient for different values of the local level SE</p>
<pre class="sourceCode r"><code class="sourceCode r">results$PlotPriorLevelSdAnalysis</code></pre>
<p>Store the coefficients in a data.frame</p>
<pre class="sourceCode r"><code class="sourceCode r">coeff &lt;-<span class="st"> </span>results$Coefficients
knitr::<span class="kw">kable</span>(<span class="kw">head</span>(coeff))</code></pre>
</div>
<div id="references" class="section level1">
<h1>References</h1>
<p>[1] CausalImpact version 1.0.3, Brodersen et al., Annals of Applied Statistics (2015). <a href="http://google.github.io/CausalImpact/" class="uri">http://google.github.io/CausalImpact/</a></p>
<p>[2] Vignette for the <code>dtw</code> package: <a href="https://cran.r-project.org/web/packages/dtw/vignettes/dtw.pdf" class="uri">https://cran.r-project.org/web/packages/dtw/vignettes/dtw.pdf</a>.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
